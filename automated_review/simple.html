<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CFBench Simple Review</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.5;
            padding: 20px;
        }
        .container { max-width: 900px; margin: 0 auto; }
        h1 { font-size: 1.5rem; margin-bottom: 20px; color: #1a1a1a; }

        .upload-box {
            background: white;
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 20px;
        }
        .upload-box:hover { border-color: #2563eb; background: #f8fafc; }
        .upload-box.dragover { border-color: #2563eb; background: #eff6ff; }

        .file-info {
            background: white;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            justify-content: space-between;
            align-items: center;
        }
        .file-info.show { display: flex; }

        .btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .btn:hover { background: #1d4ed8; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }

        .results {
            background: white;
            border-radius: 8px;
            padding: 20px;
            display: none;
        }
        .results.show { display: block; }

        .section {
            margin-bottom: 24px;
        }
        .section h2 {
            font-size: 1rem;
            color: #666;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        th {
            text-align: left;
            padding: 10px 12px;
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #eee;
        }
        td {
            padding: 10px 12px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: top;
        }
        tr:hover { background: #fafafa; }

        .constraint-name { font-weight: 500; }
        .constraint-id { font-size: 0.7rem; color: #999; }

        .quote {
            font-style: italic;
            color: #666;
            font-size: 0.8rem;
            max-width: 350px;
            word-break: break-word;
        }

        .status {
            font-weight: 600;
            text-align: center;
            padding: 4px 12px;
            border-radius: 4px;
        }
        .status.pass { background: #d1fae5; color: #059669; }
        .status.fail { background: #fee2e2; color: #dc2626; }

        .summary {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
        }
        .summary-item {
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 500;
        }
        .summary-item.pass { background: #d1fae5; color: #059669; }
        .summary-item.fail { background: #fee2e2; color: #dc2626; }
        .summary-item.total { background: #e5e7eb; color: #374151; }

        .debug {
            background: #f8f9fa;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 12px;
            margin-top: 20px;
            font-size: 0.75rem;
            color: #666;
        }
        .debug summary { cursor: pointer; font-weight: 500; }
        .debug pre {
            margin-top: 8px;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 200px;
            overflow-y: auto;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CFBench Simple Review</h1>

        <div class="upload-box" id="upload-box" onclick="document.getElementById('file-input').click()">
            <div style="font-size: 2rem; margin-bottom: 10px;">ðŸ“„</div>
            <div>Drop .py or .ipynb file here</div>
            <div style="color: #999; font-size: 0.85rem; margin-top: 8px;">or click to select</div>
            <input type="file" id="file-input" accept=".py,.ipynb" style="display: none;">
        </div>

        <div class="file-info" id="file-info">
            <span id="file-name">filename.py</span>
            <button class="btn" id="analyze-btn" onclick="analyze()">Analyze</button>
        </div>

        <div class="results" id="results">
            <div class="summary" id="summary"></div>

            <div class="section" id="user-section">
                <h2>ðŸ“‹ Constraints (source: user) â†’ Must be in User Query</h2>
                <div id="user-table"></div>
            </div>

            <div class="section" id="system-section">
                <h2>ðŸ“‹ Constraints (source: system) â†’ Must be in System Prompt</h2>
                <div id="system-table"></div>
            </div>

            <details class="debug">
                <summary>Debug Info</summary>
                <pre id="debug-info"></pre>
            </details>
        </div>
    </div>

    <script src="js/simple_parser.js"></script>
    <script src="js/simple_checker.js"></script>
    <script>
        let fileContent = null;
        const parser = new SimpleParser();
        const checker = new SimpleChecker();

        // File input
        document.getElementById('file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) loadFile(file);
        });

        // Drag & drop
        const uploadBox = document.getElementById('upload-box');
        uploadBox.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadBox.classList.add('dragover');
        });
        uploadBox.addEventListener('dragleave', () => {
            uploadBox.classList.remove('dragover');
        });
        uploadBox.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadBox.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) loadFile(file);
        });

        function loadFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                fileContent = e.target.result;

                // If .ipynb, extract the docstring content
                if (file.name.endsWith('.ipynb')) {
                    try {
                        const nb = JSON.parse(fileContent);
                        // Combine all cell sources
                        fileContent = nb.cells.map(c => {
                            const src = Array.isArray(c.source) ? c.source.join('') : c.source;
                            return src;
                        }).join('\n\n');
                    } catch (e) {
                        console.error('Failed to parse .ipynb:', e);
                    }
                }

                document.getElementById('file-name').textContent = file.name;
                document.getElementById('file-info').classList.add('show');
            };
            reader.readAsText(file);
        }

        function analyze() {
            if (!fileContent) return;

            // Parse
            const parsed = parser.parse(fileContent);

            // Check constraints
            const results = checker.check(parsed);

            // Show results
            showResults(parsed, results);
        }

        function showResults(parsed, results) {
            document.getElementById('results').classList.add('show');

            // Summary
            const summaryHtml = `
                <div class="summary-item total">Total: ${results.summary.total}</div>
                <div class="summary-item pass">âœ“ Pass: ${results.summary.pass}</div>
                <div class="summary-item fail">âœ— Fail: ${results.summary.fail}</div>
            `;
            document.getElementById('summary').innerHTML = summaryHtml;

            // User constraints table
            if (results.userConstraints.length > 0) {
                document.getElementById('user-table').innerHTML = buildTable(results.userConstraints);
            } else {
                document.getElementById('user-table').innerHTML = '<div class="empty-state">No user-source constraints found</div>';
            }

            // System constraints table
            if (results.systemConstraints.length > 0) {
                document.getElementById('system-table').innerHTML = buildTable(results.systemConstraints);
            } else {
                document.getElementById('system-table').innerHTML = '<div class="empty-state">No system-source constraints found</div>';
            }

            // Debug info
            const debugInfo = {
                lastUserQueryLength: parsed.lastUserQuery?.length || 0,
                lastUserQueryPreview: parsed.lastUserQuery?.substring(0, 300) + '...',
                systemPromptLength: parsed.system?.length || 0,
                turnMetadataFound: !!parsed.turnMetadata,
                instructionsCount: parsed.turnMetadata?.instructions?.length || 0
            };
            document.getElementById('debug-info').textContent = JSON.stringify(debugInfo, null, 2);
        }

        function buildTable(constraints) {
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th style="width: 30%;">Constraint</th>
                            <th style="width: 50%;">Quote from Text</th>
                            <th style="width: 20%;">Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            for (const c of constraints) {
                html += `
                    <tr>
                        <td>
                            <div class="constraint-name">${escapeHtml(c.description)}</div>
                            <div class="constraint-id">${escapeHtml(c.id)}</div>
                        </td>
                        <td class="quote">${escapeHtml(c.quote)}</td>
                        <td><span class="status ${c.status.toLowerCase()}">${c.status === 'PASS' ? 'âœ“ PASS' : 'âœ— FAIL'}</span></td>
                    </tr>
                `;
            }

            html += '</tbody></table>';
            return html;
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;')
                      .replace(/"/g, '&quot;');
        }
    </script>
</body>
</html>
